import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import java.io.*;
import java.util.*;

public class ExcelIngestion {
    // Declare final lists to hold all the objects
    final List<Buyer> buyersList = new ArrayList<>();
    final List<Agent> agentsList = new ArrayList<>();
    final List<House> housesList = new ArrayList<>();
    final List<Unit> unitsList = new ArrayList<>();
    final List<Townhouse> townhousesList = new ArrayList<>();
    final List<DevelopmentSite> developmentSitesList = new ArrayList<>();
    final List<Transaction> transactionsList = new ArrayList<>();
    final List<Location> locationList = new ArrayList<>();

    public List<List<String>> excelImport(String filePath) {
        List<List<String>> data = new ArrayList<>();
        try (FileInputStream fis = new FileInputStream(filePath)) {
            Workbook workbook = new XSSFWorkbook(fis);
            Sheet sheet = workbook.getSheetAt(0);  // Get the first sheet
            Iterator<Row> rowIterator = sheet.iterator();
            rowIterator.next(); // Skip header row
            while (rowIterator.hasNext()) {
                Row row = rowIterator.next();
                List<String> rowData = new ArrayList<>();
                for (int i = 0; i < row.getPhysicalNumberOfCells(); i++) {
                    Cell cell = row.getCell(i);
                    rowData.add(cell.toString());  // Add cell value as string
                }
                data.add(rowData);  // Add the row data to the list
            }
            workbook.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return data;
    }

    public void excelInject(List<List<String>> data) {
        for (List<String> row : data) {
            try {
                // Extract values from the row based on expected column indexes
                String address = row.get(1);
                int rooms = Integer.parseInt(row.get(2));
                String type = row.get(3);
                double price = Double.parseDouble(row.get(4));
                String method = row.get(5);
                String agentName = row.get(6);
                String date = row.get(7);
                double distance = Double.parseDouble(row.get(8));
                int postcode = Integer.parseInt(row.get(9));
                int bathroom = Integer.parseInt(row.get(10));
                int parkingSpot = Integer.parseInt(row.get(11));
                int landsize = Integer.parseInt(row.get(12));
                int buildingSize = Integer.parseInt(row.get(13));
                int yearBuilt = row.get(14).equals("") ? 0 : Integer.parseInt(row.get(14));
                String councilArea = row.get(15);
                double latitude = Double.parseDouble(row.get(16));
                double longitude = Double.parseDouble(row.get(17));
                String regionName = row.get(18);
                int propertyCount = Integer.parseInt(row.get(19));
                boolean hasGarden = Boolean.parseBoolean(row.get(20));
                boolean hasSwimmingPool = Boolean.parseBoolean(row.get(21));
                boolean hasFence = Boolean.parseBoolean(row.get(22));
                int propertyId = Integer.parseInt(row.get(23));
                boolean isLandCleared = Boolean.parseBoolean(row.get(24));
                int numberOfSharedWalls = Integer.parseInt(row.get(25));
                int numberOfLevels = Integer.parseInt(row.get(26));
                boolean underConstruction = Boolean.parseBoolean(row.get(27));
                int agentId = Integer.parseInt(row.get(28));
                String buyerName = row.get(29);
                int buyerId = Integer.parseInt(row.get(30));
                char gender = row.get(31).charAt(0);
                int age = Integer.parseInt(row.get(32));
                int floorLevel = Integer.parseInt(row.get(33));
                boolean hasBalcony = Boolean.parseBoolean(row.get(34));
                int transactionId = Integer.parseInt(row.get(35));
                boolean hasElevator = Boolean.parseBoolean(row.get(36));
                
                // Create the Location object
                Location location = new Location(regionName, address, latitude, longitude, 
                                                 distance, postcode, councilArea, propertyCount);
                locationList.add(location);
                
                if (type.equals("h")) {
                    // Create the House object
                    House house = new House(propertyId, landsize, location, rooms, bathroom, parkingSpot, buildingSize, yearBuilt, hasGarden, hasSwimmingPool, hasFence);
                    housesList.add(house);
                } else if (type.equals("u")) {
                    // Create the Unit object
                    Unit unit = new Unit(propertyId, landsize, location, rooms, bathroom, parkingSpot, buildingSize, yearBuilt, floorLevel, hasBalcony, hasElevator);
                    unitsList.add(unit); 
                } else if (type.equals("t")) {
                    // Create the Townhouse object
                    Townhouse townhouse = new Townhouse(propertyId, landsize, location, rooms, bathroom, parkingSpot, buildingSize, yearBuilt, numberOfSharedWalls, numberOfLevels);
                    townhousesList.add(townhouse);
                } else if (type.equals("dev")) {
                    // Create the DevelopmentSite object
                    DevelopmentSite developmentSite = new DevelopmentSite(propertyId, landsize, location, isLandCleared, underConstruction);
                    developmentSitesList.add(developmentSite);
                } else {
                    System.out.println("Unknown property type: " + type);
                }

                // Create transaction object
                Transaction transaction = new Transaction(transactionId, price, method, agentId, buyerId, propertyId, date);
                transactionsList.add(transaction);
                
                // Check if the Buyer exists
                boolean buyerExists = false;
                for (Buyer buyer : buyersList) {
                    if (buyer.getBuyerId() == buyerId) {
                        buyerExists = true;
                        break;
                    }
                }

                // If the Buyer doesn't exist, create and add to the list
                if (!buyerExists) {
                    Buyer buyer = new Buyer(buyerId, buyerName, gender, age);
                    buyersList.add(buyer);
                }
                
                // Check if the Agent exists
                boolean agentExists = false;
                for (Agent agent : agentsList) {
                    if (agent.getAgentId() == agentId) {
                        agentExists = true;
                        break;
                    }
                }

                // If the Agent doesn't exist, create and add to the list
                if (!agentExists) {
                    Agent agent = new Agent(agentId, agentName);
                    agentsList.add(agent);
                }

            } catch (Exception e) {
                System.out.println("Error processing row: " + row);
                e.printStackTrace();
            }
        }
    }
}


